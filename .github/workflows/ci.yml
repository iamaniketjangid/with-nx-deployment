name: CI With Nx (Heavy & Optimized)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout (full history required for nx affected)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # 3️⃣ Install dependencies (CENTRALIZED ✅)
      - name: Install dependencies
        run: npm ci

      # 4️⃣ Format check (affected-aware)
      - name: Format check
        run: npx nx format:check --base=origin/main

      # 5️⃣ Heavy tasks but ONLY for affected projects ✅
      - name: Lint, Test, Typecheck, Build (affected)
        run: |
          npx nx affected \
            -t lint test typecheck build \
            --parallel=4 \
            --base=origin/main

      # 6️⃣ E2E (only if affected)
      - name: E2E tests (affected)
        run: |
          npx nx affected \
            -t e2e \
            --parallel=2 \
            --base=origin/main

      # 7️⃣ Security audit (do not fail pipeline)
      - name: Dependency audit
        run: npm audit --audit-level=critical || true

      # 8️⃣ Done
      - name: Pipeline completed
        run: echo "CI With Nx completed (fast & optimized)"
