name: CI With Nx (Heavy & Optimized)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # IMPORTANT for nx affected

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      # ---------- FORMAT CHECK ----------
      - name: Format check
        run: npx nx format:check --base=origin/main

      # ---------- LINT / TEST / TYPECHECK / BUILD ----------
      - name: Nx affected (heavy targets)
        run: |
          npx nx affected \
            -t lint test typecheck build \
            --parallel=4 \
            --base=origin/main

      # ---------- E2E (ONLY IF AFFECTED) ----------
      - name: E2E tests
        run: |
          npx nx affected \
            -t e2e \
            --parallel=2 \
            --base=origin/main

      # ---------- SECURITY CHECK ----------
      - name: Dependency audit
        run: npm audit --audit-level=high

      # ---------- ARTIFACT ----------
      - name: Upload affected build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: affected-build
